{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
    :root {
        --primary: #3498db;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --dark: #2c3e50;
        --light: #ecf0f1;
        --gray: #95a5a6;
        --purple: #9b59b6;
        --teal: #1abc9c;
    }

    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--light);
    }

    .dashboard-title {
        font-size: 2.5rem;
        color: var(--dark);
        margin: 0;
        font-weight: 300;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s ease;
    }

    .stat-card:hover { transform: translateY(-5px); }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .stat-card:nth-child(1) .stat-number { color: var(--primary); }
    .stat-card:nth-child(2) .stat-number { color: var(--success); }
    .stat-card:nth-child(3) .stat-number { color: var(--warning); }
    .stat-card:nth-child(4) .stat-number { color: var(--purple); }

    .stat-label {
        color: var(--gray);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .chart-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .section-title {
        font-size: 1.5rem;
        color: var(--dark);
        margin: 0;
        font-weight: 500;
    }

    .chart-canvas {
        width: 100% !important;
        height: 400px !important;
    }

    .table-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        overflow-x: auto;
    }

    .admin-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .admin-table th {
        background: var(--light);
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: var(--dark);
        border-bottom: 2px solid var(--light);
    }

    .admin-table td {
        padding: 15px;
        border-bottom: 1px solid var(--light);
    }

    .admin-table tr:hover { background: #f8f9fa; }

    .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .badge-success { background: var(--success); color: white; }
    .badge-warning { background: var(--warning); color: white; }
    .badge-danger { background: var(--danger); color: white; }
    .badge-info { background: var(--primary); color: white; }
    .badge-purple { background: var(--purple); color: white; }
    .badge-teal { background: var(--teal); color: white; }

    .device-pie-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        align-items: center;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    @media (max-width: 1024px) {
        .chart-grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
        .stats-grid { grid-template-columns: 1fr; }
        .device-pie-container { grid-template-columns: 1fr; }
        .chart-canvas { height: 300px !important; }
        .dashboard-title { font-size: 2rem; }
    }

    .refresh-btn {
        background: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.2s ease;
    }
    .refresh-btn:hover { background: #2980b9; }
</style>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1 class="dashboard-title">📊 Advanced Analytics Dashboard</h1>
        <div>
            <button class="refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
            <a href="{% url 'export_dashboard_csv' %}" class="refresh-btn" style="background:#2ecc71;">📥 Export CSV</a>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_visits_today }}</div>
            <div class="stat-label">Visits Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ unique_visitors_today }}</div>
            <div class="stat-label">Unique Visitors</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_users }}</div>
            <div class="stat-label">Active Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_referrals }}</div>
            <div class="stat-label">Total Referrals</div>
        </div>
    </div>

    <!-- User Growth Charts -->
    <div class="chart-grid">
        <div class="chart-container">
            <div class="section-header">
                <h2 class="section-title">📈 New Users Per Month</h2>
            </div>
            <canvas id="monthlyUsersChart" class="chart-canvas"></canvas>
        </div>

        <div class="chart-container">
            <div class="section-header">
                <h2 class="section-title">🚀 Cumulative User Growth</h2>
            </div>
            <canvas id="cumulativeUsersChart" class="chart-canvas"></canvas>
        </div>
    </div>

    <!-- User Demographics -->
    <div class="chart-container">
        <div class="section-header">
            <h2 class="section-title">👥 User Demographics</h2>
        </div>
        <div class="device-pie-container">
            <canvas id="userDemographicsChart" class="chart-canvas"></canvas>
            <div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-info">Total Users: {{ user_stats.total_users }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-success">Users with Business: {{ user_stats.users_with_business }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-warning">Users without Business: {{ user_stats.users_without_business }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-purple">Business Owners: {{ user_stats.business_owners }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-teal">Active Users (Last 30 days): {{ user_stats.active_users_30_days }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Traffic -->
    <div class="chart-container">
        <div class="section-header">
            <h2 class="section-title">🚀 Daily Traffic (Last 30 Days)</h2>
        </div>
        <canvas id="dailyTrafficChart" class="chart-canvas"></canvas>
    </div>

    <!-- Device Breakdown -->
    <div class="chart-container">
        <div class="section-header">
            <h2 class="section-title">📱 Device Breakdown</h2>
        </div>
        <div class="device-pie-container">
            <canvas id="deviceChart" class="chart-canvas"></canvas>
            <div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-info">Desktop: {{ device_breakdown.desktop }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-success">Mobile: {{ device_breakdown.mobile }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-warning">Tablet: {{ device_breakdown.tablet }}</span>
                </div>
                <div style="margin-bottom: 15px;">
                    <span class="badge badge-danger">Bots: {{ device_breakdown.bot }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Referrers -->
    <div class="table-container">
        <div class="section-header"><h2 class="section-title">👥 Top Referrers</h2></div>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Referrer</th>
                    <th>Total Referrals</th>
                    <th>Successful Conversions</th>
                    <th>Conversion Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in top_referrers %}
                <tr>
                    <td>{{ ref.referrer__username|default:"Anonymous" }}</td>
                    <td>{{ ref.total }}</td>
                    <td>{{ ref.conversions }}</td>
                    <td>{% widthratio ref.conversions ref.total 100 %}%</td>
                </tr>
                {% empty %}
                <tr><td colspan="4" style="text-align:center;color:var(--gray);">No referral data</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Top Pages -->
    <div class="table-container">
        <div class="section-header"><h2 class="section-title">🌐 Most Visited Pages</h2></div>
        <table class="admin-table">
            <thead>
                <tr><th>Page</th><th>Total Visits</th><th>Unique Visitors</th></tr>
            </thead>
            <tbody>
                {% for page in top_pages %}
                <tr>
                    <td><code>{{ page.path|truncatechars:50 }}</code></td>
                    <td>{{ page.visits }}</td>
                    <td>{{ page.unique_visitors }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" style="text-align:center;color:var(--gray);">No page visit data</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function refreshData() {
    window.location.search = '?refresh=true';
}

document.addEventListener('DOMContentLoaded', function() {
    // Monthly Users Chart
    new Chart(document.getElementById('monthlyUsersChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'New Users',
                data: {{ monthly_counts|safe }},
                backgroundColor: 'rgba(46, 204, 113, 0.2)',
                borderColor: 'rgba(46, 204, 113, 1)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'top' } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    // Cumulative Users Chart
    new Chart(document.getElementById('cumulativeUsersChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: {{ cumulative_users_labels|safe }},
            datasets: [{
                label: 'Total Users',
                data: {{ cumulative_users_data|safe }},
                backgroundColor: 'rgba(155, 89, 182, 0.2)',
                borderColor: 'rgba(155, 89, 182, 1)',
                borderWidth: 3,
                tension: 0.1,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'top' } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // User Demographics Chart
    new Chart(document.getElementById('userDemographicsChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['With Business', 'Without Business', 'Business Owners'],
            datasets: [{
                data: [
                    {{ user_stats.users_with_business }},
                    {{ user_stats.users_without_business }},
                    {{ user_stats.business_owners }}
                ],
                backgroundColor: ['#2ecc71', '#f39c12', '#9b59b6'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const value = context.raw;
                            const percentage = Math.round((value / total) * 100);
                            return `${context.label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Daily Traffic Chart
    new Chart(document.getElementById('dailyTrafficChart').getContext('2d'), {
        type: 'bar',
        data: {
            labels: {{ daily_labels|safe }},
            datasets: [{
                label: 'Daily Visits',
                data: {{ daily_counts|safe }},
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true, position: 'top' } },
            scales: { y: { beginAtZero: true } }
        }
    });

    // Device Breakdown Chart
    new Chart(document.getElementById('deviceChart').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: ['Desktop', 'Mobile', 'Tablet', 'Bots', 'Unknown'],
            datasets: [{
                data: [
                    {{ device_breakdown.desktop }},
                    {{ device_breakdown.mobile }},
                    {{ device_breakdown.tablet }},
                    {{ device_breakdown.bot }},
                    {{ device_breakdown.unknown }}
                ],
                backgroundColor: ['#a55eea','#4ecdc4','#45aaf2','#ff6b6b','#95a5a6'],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }
        }
    });
});
</script>
{% endblock %}